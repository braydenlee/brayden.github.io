<!doctype html><html lang>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Issue description Previously, bootable ISO image usually has the efi.img and ISOLINUX embeded which are required to boot the ISO and facilitate the installer.
However, Ubuntu 22.04 replaced ISOLINUX package with EI-Torito and the efi.img with the efi boot partition in the live filesystem on the ISO. So previous methods or commands that relies on the isolinux/isolinux.bin, and efi.img no longer work.
My initial approach was to bring back the efi."><title>Re-pack Ubuntu 22.04 live server ISO</title><link rel=canonical href=/posts/re-pack-ubuntu-22.04-live-server-iso/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Re-pack Ubuntu 22.04 live server ISO">
<meta property="og:description" content="Issue description Previously, bootable ISO image usually has the efi.img and ISOLINUX embeded which are required to boot the ISO and facilitate the installer.
However, Ubuntu 22.04 replaced ISOLINUX package with EI-Torito and the efi.img with the efi boot partition in the live filesystem on the ISO. So previous methods or commands that relies on the isolinux/isolinux.bin, and efi.img no longer work.
My initial approach was to bring back the efi.">
<meta property="og:url" content="/posts/re-pack-ubuntu-22.04-live-server-iso/">
<meta property="og:site_name" content="Brayden's Blog">
<meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="ISO"><meta property="article:tag" content="ubuntu"><meta property="article:published_time" content="2022-03-06T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-06T00:00:00+00:00"><meta property="og:image" content="/images/iso_disc.png">
<meta name=twitter:title content="Re-pack Ubuntu 22.04 live server ISO">
<meta name=twitter:description content="Issue description Previously, bootable ISO image usually has the efi.img and ISOLINUX embeded which are required to boot the ISO and facilitate the installer.
However, Ubuntu 22.04 replaced ISOLINUX package with EI-Torito and the efi.img with the efi boot partition in the live filesystem on the ISO. So previous methods or commands that relies on the isolinux/isolinux.bin, and efi.img no longer work.
My initial approach was to bring back the efi."><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="/images/iso_disc.png">
</head><body class="article-page has-toc">
<script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div><main class="main full-width">
<article class="has-image main-article">
<header class=article-header>
<div class=article-image>
<a href=/posts/re-pack-ubuntu-22.04-live-server-iso/>
<img src=/images/iso_disc.png loading=lazy alt="Featured image of post Re-pack Ubuntu 22.04 live server ISO">
</a>
</div><div class=article-details>
<section class=article-tags>
<a href=/tags/iso/>ISO</a>
<a href=/tags/ubuntu/>ubuntu</a>
</section><h2 class=article-title>
<a href=/posts/re-pack-ubuntu-22.04-live-server-iso/>Re-pack Ubuntu 22.04 live server ISO</a>
</h2><footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 06, 2022</time>
</div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
4 minute read
</time>
</div></footer></div></header><section class=article-content>
<h2 id=issue-description>Issue description</h2><p>Previously, bootable ISO image usually has the efi.img and ISOLINUX embeded which are required to boot the ISO and facilitate the installer.<br>
However, Ubuntu 22.04 replaced ISOLINUX package with EI-Torito and the efi.img with the efi boot partition in the live filesystem on the ISO. So previous methods or commands that relies on the isolinux/isolinux.bin, and efi.img no longer work.<br>
My initial approach was to bring back the efi.img and add the isolinux package, that&rsquo;s what I&rsquo;m fimiliar with, and faster to get the bootable ISO created. Although the principle is quite straightforward, the detailed steps to accomplish is bit complex and in-elegent.<br>
This post will present another approach, which is used to create the Ubuntu 22.04 live ISO.</p><h2 id=solution>Solution</h2><h3 id=the-recipe-to-reproduce-the-iso>The recipe to reproduce the ISO</h3><p>xorriso has an option which could show how the ISO is cooked and so you could use the same recipe to reproduce it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ xorriso -indev ../jammy-live-server-amd64.iso -report_el_torito as_mkisofs  
</span></span><span style=display:flex><span>xorriso 1.5.4 : RockRidge filesystem manipulator, libburnia project.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>xorriso : NOTE : Loading ISO image tree from LBA <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>xorriso : UPDATE :     <span style=color:#ae81ff>810</span> nodes read in <span style=color:#ae81ff>1</span> seconds
</span></span><span style=display:flex><span>libisofs: NOTE : Found hidden El-Torito image <span style=color:#66d9ef>for</span> EFI.
</span></span><span style=display:flex><span>libisofs: NOTE : EFI image start and size: <span style=color:#ae81ff>685590</span> * <span style=color:#ae81ff>2048</span> , <span style=color:#ae81ff>8504</span> * <span style=color:#ae81ff>512</span>
</span></span><span style=display:flex><span>xorriso : NOTE : Detected El-Torito boot information which currently is set to be discarded
</span></span><span style=display:flex><span>Drive current: -indev <span style=color:#e6db74>&#39;../jammy-live-server-amd64.iso&#39;</span>
</span></span><span style=display:flex><span>Media current: stdio file, overwriteable
</span></span><span style=display:flex><span>Media status : is written , is appendable
</span></span><span style=display:flex><span>Boot record  : El Torito , MBR protective-msdos-label grub2-mbr cyl-align-off GPT
</span></span><span style=display:flex><span>Media summary: <span style=color:#ae81ff>1</span> session, <span style=color:#ae81ff>687882</span> data blocks, 1344m data,  802g free
</span></span><span style=display:flex><span>Volume id    : <span style=color:#e6db74>&#39;Ubuntu-Server 22.04 LTS amd64&#39;</span>
</span></span><span style=display:flex><span>-V <span style=color:#e6db74>&#39;Ubuntu-Server 22.04 LTS amd64&#39;</span>
</span></span><span style=display:flex><span>--modification-date<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2022021411383300&#39;</span>
</span></span><span style=display:flex><span>--grub2-mbr --interval:local_fs:0s-15s:zero_mbrpt,zero_gpt:<span style=color:#e6db74>&#39;../jammy-live-server-amd64.iso&#39;</span>
</span></span><span style=display:flex><span>--protective-msdos-label
</span></span><span style=display:flex><span>-partition_cyl_align off
</span></span><span style=display:flex><span>-partition_offset <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>--mbr-force-bootable
</span></span><span style=display:flex><span>-append_partition <span style=color:#ae81ff>2</span> 28732ac11ff8d211ba4b00a0c93ec93b --interval:local_fs:2742360d-2750863d::<span style=color:#e6db74>&#39;../jammy-live-server-amd64.iso&#39;</span>
</span></span><span style=display:flex><span>-appended_part_as_gpt
</span></span><span style=display:flex><span>-iso_mbr_part_type a2a0d0ebe5b9334487c068b6b72699c7
</span></span><span style=display:flex><span>-c <span style=color:#e6db74>&#39;/boot.catalog&#39;</span>
</span></span><span style=display:flex><span>-b <span style=color:#e6db74>&#39;/boot/grub/i386-pc/eltorito.img&#39;</span>
</span></span><span style=display:flex><span>-no-emul-boot
</span></span><span style=display:flex><span>-boot-load-size <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>-boot-info-table
</span></span><span style=display:flex><span>--grub2-boot-info
</span></span><span style=display:flex><span>-eltorito-alt-boot
</span></span><span style=display:flex><span>-e <span style=color:#e6db74>&#39;--interval:appended_partition_2_start_685590s_size_8504d:all::&#39;</span>
</span></span><span style=display:flex><span>-no-emul-boot
</span></span><span style=display:flex><span>-boot-load-size <span style=color:#ae81ff>8504</span>
</span></span></code></pre></div><p>You now have all the secret recipes that is used to create the original live bootable ISO, simply copy and reuse it.</p><h3 id=an-elegant-method-to-apply-your-customizations-to-the-iso>An elegant method to apply your customizations to the ISO</h3><p>Most of the existing methods, requires copy the whole content from the ISO to another folder, add the write permission and then apply the changes.
It works well - except for some ISOs, you need to pay attention to some of the link files which may results in recursive copying the content. (refer to rsync use in <a class=link href=https://help.ubuntu.com/community/InstallCDCustomization target=_blank rel=noopener>Ubuntu install CD Customization</a>)
However, if the original ISO is frequently updated, for example, you are using an early daily build of a new release, you will need to copy and update the files from time to time. Kind of boring and waste of time.
Inspired by the livefs-edit project, I&rsquo;m now using the overlay fs technology, which isolate the original iso and the customization content into separate layers, and could be updated separately.</p><ol>
<li>mount the original iso as lower layer</li><li>mount the customized content as the upper layer;</li><li>generate the new iso using the overlay;</li></ol><p>With this approach, you could simply mount the new input iso as the lower layer, re-use the upper layer to generate the new customized iso. No need to copy the content and modify the content.
Super efficient and elegant.
Here&rsquo;s an step by step example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ mkdir content  
</span></span><span style=display:flex><span>$ mkdir content/base  
</span></span><span style=display:flex><span>$ mkdir content/upper  
</span></span><span style=display:flex><span>$ mkdir content/work  
</span></span><span style=display:flex><span>$ mkdir content/ol  
</span></span><span style=display:flex><span>$ mount ubuntu.iso content/base  
</span></span><span style=display:flex><span><span style=color:#ae81ff>\#</span> copy the new content to content/upper
</span></span><span style=display:flex><span><span style=color:#ae81ff>\#</span> <span style=color:#66d9ef>for</span> example a new boot/grub/grub.cfg, the autoinstall files user_data, metadata etc.
</span></span><span style=display:flex><span>$ mount -t overlay -o lowerdir<span style=color:#f92672>=</span>content/base,upperdir<span style=color:#f92672>=</span>content/upper,workdir<span style=color:#f92672>=</span>content/work non content/ol
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ xorriso -as mkisofs &lt;the options copied from original recipe&gt; -o &lt;new image&gt;.iso ./content/ol
</span></span></code></pre></div><h2 id=acknoledgement>Acknoledgement</h2><p>Special thanks to the <a class=link href=https://github.com/mwhudson/livefs-editor target=_blank rel=noopener>livefs_edit project</a>, where I first tried the livefs_edit, and then learned howto use xorriso to retrieve the recipes and reproduce the ISO.</p><h2 id=reference>Reference</h2><p><a class=link href=https://wiki.debian.org/RepackBootableISO target=_blank rel=noopener>Repack Bootable ISO</a>
<a class=link href=https://utcc.utoronto.ca/~cks/space/blog/linux/Ubuntu2004ISOWithUEFI-2 target=_blank rel=noopener>Ubuntu 20.04 bootable ISO for EFI</a>
<a class=link href=https://www.gnu.org/software/xorriso/man_1_xorrisofs.html target=_blank rel=noopener>xorriso man page</a>
<a class=link href=https://help.ubuntu.com/community/InstallCDCustomization target=_blank rel=noopener>Ubuntu install CD Customization</a>
<a class=link href=https://help.ubuntu.com/community/LiveCDCustomization target=_blank rel=noopener>Ubuntu Live CD Customization</a></p></section><footer class=article-footer>
<header class=article-category>
<a href=/categories/memos/>
memos
</a>
<a href=/categories/tips/>
tips
</a>
</header></footer></article><aside class=related-contents--wrapper>
<h2 class=section-title>Related contents</h2><div class=related-contents>
<div class="flex article-list--tile">
<article class=has-image>
<a href=/posts/setting_up_nfs_server/>
<div class=article-image>
<img src=/images/kissclipart-nfs.png loading=lazy data-key data-hash=/images/kissclipart-nfs.png>
</div><div class=article-details>
<h2 class=article-title>Setting Up NFS Server</h2></div></a>
</article><article class=has-image>
<a href=/posts/recover_ubuntu_from_initramfs_error/>
<div class=article-image>
<img src=/images/initramfs.png loading=lazy data-key data-hash=/images/initramfs.png>
</div><div class=article-details>
<h2 class=article-title>Recover Ubuntu from initramfs error caused by improper shutdown</h2></div></a>
</article><article class=has-image>
<a href=/posts/dual_home_ubuntu/>
<div class=article-image>
<img src=/images/Networking.jpg loading=lazy data-key data-hash=/images/Networking.jpg>
</div><div class=article-details>
<h2 class=article-title>Route setting in Multihomed Server</h2></div></a>
</article></div></div></aside><div class=disqus-container>
<div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//brayblog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2022 Brayden's Blog
</section><section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.5.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div><div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main><aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc>
<nav id=TableOfContents>
<ul>
<li><a href=#issue-description>Issue description</a></li><li><a href=#solution>Solution</a>
<ul>
<li><a href=#the-recipe-to-reproduce-the-iso>The recipe to reproduce the ISO</a></li><li><a href=#an-elegant-method-to-apply-your-customizations-to-the-iso>An elegant method to apply your customizations to the ISO</a></li></ul></li><li><a href=#acknoledgement>Acknoledgement</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script>
</body></html>