<!doctype html><html lang>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Introduction High availability and Load Balancing are the most important features for online services, especially for services in production.
This memo will provide a step-by-step guide for how-to setup the load balancing and High availability for an online web services. The web service used here as the experimental setup, is kubernetes api server. You could use a dummy web service hosted by nginx or httpd as well.
In this experimental setup, three servers are used"><title>High Availability & Load Balancing Setup</title>
<link rel=canonical href=/posts/high_availability-load_balancing_setup/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="High Availability & Load Balancing Setup">
<meta property="og:description" content="Introduction High availability and Load Balancing are the most important features for online services, especially for services in production.
This memo will provide a step-by-step guide for how-to setup the load balancing and High availability for an online web services. The web service used here as the experimental setup, is kubernetes api server. You could use a dummy web service hosted by nginx or httpd as well.
In this experimental setup, three servers are used">
<meta property="og:url" content="/posts/high_availability-load_balancing_setup/">
<meta property="og:site_name" content="Brayden's Blog">
<meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="HA"><meta property="article:tag" content="HAproxy"><meta property="article:tag" content="keepalived"><meta property="article:tag" content="Load balancer"><meta property="article:published_time" content="2021-12-22T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-22T00:00:00+00:00">
<meta name=twitter:title content="High Availability & Load Balancing Setup">
<meta name=twitter:description content="Introduction High availability and Load Balancing are the most important features for online services, especially for services in production.
This memo will provide a step-by-step guide for how-to setup the load balancing and High availability for an online web services. The web service used here as the experimental setup, is kubernetes api server. You could use a dummy web service hosted by nginx or httpd as well.
In this experimental setup, three servers are used">
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/memo/>
memo
</a>
<a href=/categories/tips/>
tips
</a>
</header>
<h2 class=article-title>
<a href=/posts/high_availability-load_balancing_setup/>High Availability & Load Balancing Setup</a>
</h2>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Dec 22, 2021</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
5 minute read
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h2 id=introduction>Introduction</h2>
<p>High availability and Load Balancing are the most important features for online services, especially for services in production.</p>
<p>This memo will provide a step-by-step guide for how-to setup the load balancing and High availability for an online web services. The web service used here as the experimental setup, is kubernetes api server. You could use a dummy web service hosted by nginx or httpd as well.</p>
<p>In this experimental setup, three servers are used</p>
<blockquote>
<p>node-101 192.168.8.101 # K8s master node<br>
node-102 192.168.8.102 # K8s master node<br>
node-103 192.168.8.103 # K8s master node & worker node</p>
</blockquote>
<p>First we shall implement a load balancer to serve the incoming access request to the API server using HAproxy, then implement high availability using keepalived for the HAproxy itself so there&rsquo;s no actual single point of failure in this setup. Note that, this guide implemented a active-passive mode high availability.</p>
<h2 id=prerequisites>Prerequisites</h2>
<p>The procedure is validated on Ubuntu 22.04 daily build 20211128.</p>
<ol>
<li>Make sure the apt source is configured properly, or you have the required packages and their dependencies offline.</li>
<li>Packages HAproxy and keepalived</li>
</ol>
<h2 id=detailed-steps>Detailed steps</h2>
<p>We shall deploy the HAproxy and keepalived on the same servers (node-101 & node-102) where the k8s api server resides. Note that it&rsquo;s not neccessary to be on the same servers, and on heavy loaded system, would be better to have dedicated load balancer servers to host HAproxy.</p>
<h3 id=install-the-required-packages>Install the required packages</h3>
<p>Execute the following command on both node-101 and node-102</p>
<pre><code>sudo apt install haproxy keepalived
</code></pre>
<h3 id=configure-load-balancer>Configure Load Balancer</h3>
<p>Apply the configuration on both node-101 and node-102</p>
<pre><code>sudo vim /etc/haproxy/haproxy.cfg
</code></pre>
<p>Add the frontend and backend sections to the end of the cfg file as shown below:</p>
<pre><code>global

  log /dev/log  local0
  log /dev/log  local1 notice
  chroot /var/lib/haproxy
  stats socket /run/haproxy/admin.sock mode 660 level admin expose\-fd listeners
  stats timeout 30s
  user haproxy
  group haproxy
  daemon
  \# Default SSL material locations

  ca\-base /etc/ssl/certs
  crt\-base /etc/ssl/private

  \# See: https://ssl\-config.mozilla.org/\#server=haproxy&amp;server\-version=2.0.3&amp;config=intermediate
  ssl\-default\-bind\-ciphers ECDHE\-ECDSA\-AES128\-GCM\-SHA256:ECDHE\-RSA\-AES128\-GCM\-SHA256:ECDHE\-ECDSA\-AES256\-GCM\-SHA384:ECDHE\-RSA\-AES256\-GCM\-SHA384:ECDHE\-ECDSA\-CHACHA20\-POLY1305:ECDHE\-RSA\-CHACHA20\-POLY1305:DHE\-RSA\-AES128\-GCM\-SHA256:DHE\-RSA\-AES256\-GCM\-SHA384
  ssl\-default\-bind\-ciphersuites TLS\_AES\_128\_GCM\_SHA256:TLS\_AES\_256\_GCM\_SHA384:TLS\_CHACHA20\_POLY1305\_SHA256
  ssl\-default\-bind\-options ssl\-min\-ver TLSv1.2 no\-tls\-tickets

defaults
  log  global
  mode  http
  option httplog
  option dontlognull
  timeout connect 5000
  timeout client 50000
  timeout server 50000
  
  errorfile 400 /etc/haproxy/errors/400.http      
  errorfile 403 /etc/haproxy/errors/403.http      
  errorfile 408 /etc/haproxy/errors/408.http      
  errorfile 500 /etc/haproxy/errors/500.http      
  errorfile 502 /etc/haproxy/errors/502.http      
  errorfile 503 /etc/haproxy/errors/503.http      
  errorfile 504 /etc/haproxy/errors/504.http
  
frontend k8s\-apiserver
  
  bind **192.168.8.100:8443** \#ssl crt /etc/ssl/certs/haproxy.pem      
  mode tcp      
  default\_backend kubernetes\-apiserver      
  \#option forwardfor
  
backend kubernetes\-apiserver
  mode tcp
  balance roundrobin  
  **server node\-101 192.168.8.101:6443** check verify none inter 10000  
  **server node\-102 192.168.8.102:6443** check verify none inter 10000  
  **server node\-103 192.168.8.103:6443** check verify none inter 10000  

listen stats
  bind 192.168.8.100:80      
  mode http      
  stats enable      
  stats uri 
</code></pre>
<p>Note that, 192.168.8.100 is the virtual IP which is also known as floating IP, which will be implemented by keepalived in later section. The k8s API server is provisioned and accessible via port 6443 on master nodes, and we expose the API server on <strong>192.168.8.100:8443</strong></p>
<p>Now restart the HAproxy</p>
<pre><code>sudo systemctl restart haproxy
</code></pre>
<h3 id=configure-high-availability-for-haproxy>Configure High availability for HAproxy</h3>
<p>Apply the configuration on both node-101 and node 102</p>
<pre><code>sudo vim /etc/keepalived/keepalived.conf

\# Global Settings for notifications

global\_defs {

  notification\_email {
   \&lt;yourid\&gt;@\&lt;yourdomain\&gt;.com    \# Email address for notifications
  }
 
  notification\_email\_from \&lt;yourid\&gt;@\&lt;yourdomain\&gt;.com    \# The from address for the notifications

  smtp_server 127.0.0.1    \# SMTP server address
  smtp\_connect\_timeout 15
}

\# Define the script used to check if haproxy is still working

vrrp\_script chk\_haproxy {

script &quot;/usr/bin/killall \-0 haproxy&quot;

interval 2

weight 2

}

\# Configuration for Virtual Interface

vrrp\_instance LB\_VIP {
  **interface eno2**
  **state MASTER**   \# set to MASTER on primary server, node\-101
  \#  state BACKUP   \# set to BACKUP on the secondary server node\-102

  **priority 101**   \# set to 101 on primary server, node\-101

  \# priority 99     \# set to 99 on secondary server, node\-102
                     \# so by default, node\-101 will be elected as the active proxy server \(load balancer\).
  virtual\_router\_id 51

  smtp\_alert        \# Enable Notifications Via Email
    authentication {
    auth\_type AH   
    auth\_pass myP@ssword \# Password for accessing vrrpd. Same on all devices
  }

  unicast\_src\_ip **192.168.8.101** \# Private IP address of this haproxy server, set to 8.102 for node\-102

  unicast\_peer {
    **192.168.8.102**    \# Private IP address of the peer haproxy proxy server, set to 8.101 for node\-102
  }

  \# The virtual ip address shared between the two loadbalancers
  virtual\_ipaddress {
    **192.168.8.100**
  }

  \# Use the Defined Script to Check whether to initiate a fail over

  track\_script {
    chk\_haproxy
  }
}
</code></pre>
<p>restart the keepalived service</p>
<pre><code>sudo systemctl restart keepalived
</code></pre>
<h2 id=completion>Completion</h2>
<p>If everything works as expected, you now should be able to see the virtual IP@ on eno2 in server node-101:</p>
<pre><code>ip addr show eno2
4: eno2: \&lt;BROADCAST,MULTICAST,UP,LOWER\_UP\&gt; mtu 1500 qdisc mq state UP group default qlen 1000

 link/ether 00:1e:67:e6:14:ae brd ff:ff:ff:ff:ff:ff
 altname enp3s0f3
 inet 192.168.8.101/24 scope global eno2
     valid\_lft forever preferred\_lft forever
 inet 192.168.8.100/32 scope global eno2
     valid\_lft forever preferred\_lft forever
inet6 fe80::21e:67ff:fee6:14ae/64 scope link
     valid\_lft forever preferred\_lft forever
</code></pre>
<p>and try to access the service:</p>
<pre><code>nc \-vz 192.168.8.100 8443  
Connection to 192.168.8.100 8443 port \[tcp/https\] succeeded\!
</code></pre>
<h2 id=reference>Reference</h2>
<p><a class=link href=https://www.domstamand.com/adding-haproxy-as-load-balancer-to-the-kubernetes-cluster/ target=_blank rel=noopener>Adding HAProxy as load balancer to the Kubernetes cluster | Dominique St-Amand (domstamand.com)</a><br>
<a class=link href=https://itnext.io/create-a-highly-available-kubernetes-cluster-using-keepalived-and-haproxy-37769d0a65ba target=_blank rel=noopener>Create a Highly Available Kubernetes Cluster Using Keepalived and HAproxy | by KubeSphere | ITNEXT</a><br>
<a class=link href=https://kifarunix.com/configure-highly-available-haproxy-with-keepalived-on-ubuntu-20-04/ target=_blank rel=noopener>Configure Highly Available HAProxy with Keepalived on Ubuntu 20.04</a><br>
<a class=link href=http://kifarunix.com target=_blank rel=noopener>kifarunix.com</a><br>
<a class=link href=https://kifarunix.com/install-and-setup-haproxy-on-ubuntu-20-04/#haproxyconfigurationfile target=_blank rel=noopener>Install and Setup HAProxy on Ubuntu 20.04 - kifarunix.com</a><br>
<a class=link href=https://www.retinadata.com/blog/keeping-ips-alive-without-keepalived/ target=_blank rel=noopener>Keeping IPs alive without keepalived - retinadata</a><br>
<a class=link href=https://access.redhat.com/documentation/en-us/red_hat_cloudforms/4.6/html/high_availability_guide/index target=_blank rel=noopener>High Availability Guide Red Hat CloudForms 4.6 | Red Hat Customer Portal</a><br>
<a class=link href=https://docs.d2iq.com/mesosphere/dcos/services/kubernetes/2.4.2-1.15.3/operations/exposing-the-kubernetes-api/ target=_blank rel=noopener>Exposing the Kubernetes API - D2iQ Docs</a></p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/ha/>HA</a>
<a href=/tags/haproxy/>HAproxy</a>
<a href=/tags/keepalived/>keepalived</a>
<a href=/tags/load-balancer/>Load balancer</a>
</section>
</footer>
</article>
<aside class=related-contents--wrapper>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//brayblog.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2021 -
2022 Brayden's Blog
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.5.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ul>
<li><a href=#introduction>Introduction</a></li>
<li><a href=#prerequisites>Prerequisites</a></li>
<li><a href=#detailed-steps>Detailed steps</a>
<ul>
<li><a href=#install-the-required-packages>Install the required packages</a></li>
<li><a href=#configure-load-balancer>Configure Load Balancer</a></li>
<li><a href=#configure-high-availability-for-haproxy>Configure High availability for HAproxy</a></li>
</ul>
</li>
<li><a href=#completion>Completion</a></li>
<li><a href=#reference>Reference</a></li>
</ul>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>