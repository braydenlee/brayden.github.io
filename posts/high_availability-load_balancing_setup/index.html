<!doctype html><html lang=en dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Introduction #  High availability and Load Balancing are the most important features for online services, especially for services in production.
This memo will provide a step-by-step guide for how-to setup the load balancing and High availability for an online web services. The web service used here as the experimental setup, is kubernetes api server. You could use a dummy web service hosted by nginx or httpd as well.
In this experimental setup, three servers are used">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="High Availability & Load Balancing Setup">
<meta property="og:description" content="Introduction #  High availability and Load Balancing are the most important features for online services, especially for services in production.
This memo will provide a step-by-step guide for how-to setup the load balancing and High availability for an online web services. The web service used here as the experimental setup, is kubernetes api server. You could use a dummy web service hosted by nginx or httpd as well.
In this experimental setup, three servers are used">
<meta property="og:type" content="article">
<meta property="og:url" content="https://braydenlee.github.io/posts/high_availability-load_balancing_setup/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-12-22T00:00:00+00:00">
<meta property="article:modified_time" content="2021-12-22T00:00:00+00:00">
<title>High Availability & Load Balancing Setup | Brayden's Blog</title>
<link rel=manifest href=/manifest.json>
<link rel=icon href=/favicon.png type=image/x-icon>
<link rel=stylesheet href=/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css integrity="sha256-RhgbyTN1upMgJudTs3xA5v+LsWqe93DHi8xmPkV3sbo=" crossorigin=anonymous>
<script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.a443a4e5f0b33e8aafdaa7be6d1b46766fdddddc730bf9e5490a7e0db7c9ea54.js integrity="sha256-pEOk5fCzPoqv2qe+bRtGdm/d3dxzC/nlSQp+DbfJ6lQ=" crossorigin=anonymous></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/><span>Brayden's Blog</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
<ul>
<li class=book-section-flat>
<a href=https://braydenlee.github.io/docs/example/>Brayden's Notes</a>
<ul>
<li>
<a href=https://braydenlee.github.io/docs/example/table-of-contents/>Table of Contents</a>
<ul>
<li>
<a href=https://braydenlee.github.io/docs/example/table-of-contents/with-toc/>With ToC</a>
</li>
<li>
<a href=https://braydenlee.github.io/docs/example/table-of-contents/without-toc/>Without ToC</a>
</li>
</ul>
</li>
<li>
<input type=checkbox id=section-4e46b01272d410b3a99461d79326ddf4 class=toggle>
<label for=section-4e46b01272d410b3a99461d79326ddf4 class="flex justify-between">
<a role=button>Collapsed</a>
</label>
<ul>
<li>
<a href=https://braydenlee.github.io/docs/example/collapsed/3rd-level/>3rd Level</a>
<ul>
<li>
<a href=https://braydenlee.github.io/docs/example/collapsed/3rd-level/4th-level/>4th Level</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class=book-section-flat>
<span>Shortcodes</span>
<ul>
<li>
<a href=https://braydenlee.github.io/docs/shortcodes/buttons/>Buttons</a>
</li>
<li>
<a href=https://braydenlee.github.io/docs/shortcodes/columns/>Columns</a>
</li>
<li>
<a href=https://braydenlee.github.io/docs/shortcodes/details/>Details</a>
</li>
<li>
<a href=https://braydenlee.github.io/docs/shortcodes/expand/>Expand</a>
</li>
<li>
<a href=https://braydenlee.github.io/docs/shortcodes/hints/>Hints</a>
</li>
<li>
<a href=https://braydenlee.github.io/docs/shortcodes/katex/>Katex</a>
</li>
<li>
<a href=https://braydenlee.github.io/docs/shortcodes/mermaid/>Mermaid</a>
</li>
<li>
<input type=checkbox id=section-d3fc1bf6d66cd84b896a0af9f40cb1d5 class=toggle>
<label for=section-d3fc1bf6d66cd84b896a0af9f40cb1d5 class="flex justify-between">
<a href=https://braydenlee.github.io/docs/shortcodes/section/>Section</a>
</label>
<ul>
<li>
<a href=https://braydenlee.github.io/docs/shortcodes/section/first-page/>First Page</a>
</li>
<li>
<a href=https://braydenlee.github.io/docs/shortcodes/section/second-page/>Second Page</a>
</li>
</ul>
</li>
<li>
<a href=https://braydenlee.github.io/docs/shortcodes/tabs/>Tabs</a>
</li>
</ul>
</li>
</ul>
<ul>
<li>
<a href=/posts/>
Blog
</a>
</li>
</ul>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>High Availability & Load Balancing Setup</strong>
<label for=toc-control>
<img src=/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav id=TableOfContents>
<ul>
<li><a href=#introduction>Introduction</a></li>
<li><a href=#prerequisites>Prerequisites</a></li>
<li><a href=#detailed-steps>Detailed steps</a>
<ul>
<li><a href=#install-the-required-packages>Install the required packages</a></li>
<li><a href=#configure-load-balancer>Configure Load Balancer</a></li>
<li><a href=#configure-high-availability-for-haproxy>Configure High availability for HAproxy</a></li>
</ul>
</li>
<li><a href=#completion>Completion</a></li>
<li><a href=#reference>Reference</a></li>
</ul>
</nav>
</aside>
</header>
<article class=markdown>
<h1>
<a href=/posts/high_availability-load_balancing_setup/>High Availability & Load Balancing Setup</a>
</h1>
<h5>December 22, 2021</h5>
<div>
<a href=/categories/memo/>memo</a>,
<a href=/categories/tips/>tips</a>
</div>
<div>
<a href=/tags/ha/>HA</a>,
<a href=/tags/haproxy/>HAproxy</a>,
<a href=/tags/keepalived/>keepalived</a>,
<a href=/tags/load-balancer/>Load balancer</a>
</div>
<h2 id=introduction>
Introduction
<a class=anchor href=#introduction>#</a>
</h2>
<p>High availability and Load Balancing are the most important features for online services, especially for services in production.</p>
<p>This memo will provide a step-by-step guide for how-to setup the load balancing and High availability for an online web services. The web service used here as the experimental setup, is kubernetes api server. You could use a dummy web service hosted by nginx or httpd as well.</p>
<p>In this experimental setup, three servers are used</p>
<blockquote>
<p>node-101 192.168.8.101 # K8s master node<br>
node-102 192.168.8.102 # K8s master node<br>
node-103 192.168.8.103 # K8s master node & worker node</p>
</blockquote>
<p>First we shall implement a load balancer to serve the incoming access request to the API server using HAproxy, then implement high availability using keepalived for the HAproxy itself so there&rsquo;s no actual single point of failure in this setup. Note that, this guide implemented a active-passive mode high availability.</p>
<h2 id=prerequisites>
Prerequisites
<a class=anchor href=#prerequisites>#</a>
</h2>
<p>The procedure is validated on Ubuntu 22.04 daily build 20211128.</p>
<ol>
<li>Make sure the apt source is configured properly, or you have the required packages and their dependencies offline.</li>
<li>Packages HAproxy and keepalived</li>
</ol>
<h2 id=detailed-steps>
Detailed steps
<a class=anchor href=#detailed-steps>#</a>
</h2>
<p>We shall deploy the HAproxy and keepalived on the same servers (node-101 & node-102) where the k8s api server resides. Note that it&rsquo;s not neccessary to be on the same servers, and on heavy loaded system, would be better to have dedicated load balancer servers to host HAproxy.</p>
<h3 id=install-the-required-packages>
Install the required packages
<a class=anchor href=#install-the-required-packages>#</a>
</h3>
<p>Execute the following command on both node-101 and node-102</p>
<pre><code>sudo apt install haproxy keepalived
</code></pre>
<h3 id=configure-load-balancer>
Configure Load Balancer
<a class=anchor href=#configure-load-balancer>#</a>
</h3>
<p>Apply the configuration on both node-101 and node-102</p>
<pre><code>sudo vim /etc/haproxy/haproxy.cfg
</code></pre>
<p>Add the frontend and backend sections to the end of the cfg file as shown below:</p>
<pre><code>global

  log /dev/log  local0
  log /dev/log  local1 notice
  chroot /var/lib/haproxy
  stats socket /run/haproxy/admin.sock mode 660 level admin expose\-fd listeners
  stats timeout 30s
  user haproxy
  group haproxy
  daemon
  \# Default SSL material locations

  ca\-base /etc/ssl/certs
  crt\-base /etc/ssl/private

  \# See: https://ssl\-config.mozilla.org/\#server=haproxy&amp;server\-version=2.0.3&amp;config=intermediate
  ssl\-default\-bind\-ciphers ECDHE\-ECDSA\-AES128\-GCM\-SHA256:ECDHE\-RSA\-AES128\-GCM\-SHA256:ECDHE\-ECDSA\-AES256\-GCM\-SHA384:ECDHE\-RSA\-AES256\-GCM\-SHA384:ECDHE\-ECDSA\-CHACHA20\-POLY1305:ECDHE\-RSA\-CHACHA20\-POLY1305:DHE\-RSA\-AES128\-GCM\-SHA256:DHE\-RSA\-AES256\-GCM\-SHA384
  ssl\-default\-bind\-ciphersuites TLS\_AES\_128\_GCM\_SHA256:TLS\_AES\_256\_GCM\_SHA384:TLS\_CHACHA20\_POLY1305\_SHA256
  ssl\-default\-bind\-options ssl\-min\-ver TLSv1.2 no\-tls\-tickets

defaults
  log  global
  mode  http
  option httplog
  option dontlognull
  timeout connect 5000
  timeout client 50000
  timeout server 50000
  
  errorfile 400 /etc/haproxy/errors/400.http      
  errorfile 403 /etc/haproxy/errors/403.http      
  errorfile 408 /etc/haproxy/errors/408.http      
  errorfile 500 /etc/haproxy/errors/500.http      
  errorfile 502 /etc/haproxy/errors/502.http      
  errorfile 503 /etc/haproxy/errors/503.http      
  errorfile 504 /etc/haproxy/errors/504.http
  
frontend k8s\-apiserver
  
  bind **192.168.8.100:8443** \#ssl crt /etc/ssl/certs/haproxy.pem      
  mode tcp      
  default\_backend kubernetes\-apiserver      
  \#option forwardfor
  
backend kubernetes\-apiserver
  mode tcp
  balance roundrobin  
  **server node\-101 192.168.8.101:6443** check verify none inter 10000  
  **server node\-102 192.168.8.102:6443** check verify none inter 10000  
  **server node\-103 192.168.8.103:6443** check verify none inter 10000  

listen stats
  bind 192.168.8.100:80      
  mode http      
  stats enable      
  stats uri 
</code></pre>
<p>Note that, 192.168.8.100 is the virtual IP which is also known as floating IP, which will be implemented by keepalived in later section. The k8s API server is provisioned and accessible via port 6443 on master nodes, and we expose the API server on <strong>192.168.8.100:8443</strong></p>
<p>Now restart the HAproxy</p>
<pre><code>sudo systemctl restart haproxy
</code></pre>
<h3 id=configure-high-availability-for-haproxy>
Configure High availability for HAproxy
<a class=anchor href=#configure-high-availability-for-haproxy>#</a>
</h3>
<p>Apply the configuration on both node-101 and node 102</p>
<pre><code>sudo vim /etc/keepalived/keepalived.conf

\# Global Settings for notifications

global\_defs {

  notification\_email {
   \&lt;yourid\&gt;@\&lt;yourdomain\&gt;.com    \# Email address for notifications
  }
 
  notification\_email\_from \&lt;yourid\&gt;@\&lt;yourdomain\&gt;.com    \# The from address for the notifications

  smtp_server 127.0.0.1    \# SMTP server address
  smtp\_connect\_timeout 15
}

\# Define the script used to check if haproxy is still working

vrrp\_script chk\_haproxy {

script &quot;/usr/bin/killall \-0 haproxy&quot;

interval 2

weight 2

}

\# Configuration for Virtual Interface

vrrp\_instance LB\_VIP {
  **interface eno2**
  **state MASTER**   \# set to MASTER on primary server, node\-101
  \#  state BACKUP   \# set to BACKUP on the secondary server node\-102

  **priority 101**   \# set to 101 on primary server, node\-101

  \# priority 99     \# set to 99 on secondary server, node\-102
                     \# so by default, node\-101 will be elected as the active proxy server \(load balancer\).
  virtual\_router\_id 51

  smtp\_alert        \# Enable Notifications Via Email
    authentication {
    auth\_type AH   
    auth\_pass myP@ssword \# Password for accessing vrrpd. Same on all devices
  }

  unicast\_src\_ip **192.168.8.101** \# Private IP address of this haproxy server, set to 8.102 for node\-102

  unicast\_peer {
    **192.168.8.102**    \# Private IP address of the peer haproxy proxy server, set to 8.101 for node\-102
  }

  \# The virtual ip address shared between the two loadbalancers
  virtual\_ipaddress {
    **192.168.8.100**
  }

  \# Use the Defined Script to Check whether to initiate a fail over

  track\_script {
    chk\_haproxy
  }
}
</code></pre>
<p>restart the keepalived service</p>
<pre><code>sudo systemctl restart keepalived
</code></pre>
<h2 id=completion>
Completion
<a class=anchor href=#completion>#</a>
</h2>
<p>If everything works as expected, you now should be able to see the virtual IP@ on eno2 in server node-101:</p>
<pre><code>ip addr show eno2
4: eno2: \&lt;BROADCAST,MULTICAST,UP,LOWER\_UP\&gt; mtu 1500 qdisc mq state UP group default qlen 1000

 link/ether 00:1e:67:e6:14:ae brd ff:ff:ff:ff:ff:ff
 altname enp3s0f3
 inet 192.168.8.101/24 scope global eno2
     valid\_lft forever preferred\_lft forever
 inet 192.168.8.100/32 scope global eno2
     valid\_lft forever preferred\_lft forever
inet6 fe80::21e:67ff:fee6:14ae/64 scope link
     valid\_lft forever preferred\_lft forever
</code></pre>
<p>and try to access the service:</p>
<pre><code>nc \-vz 192.168.8.100 8443  
Connection to 192.168.8.100 8443 port \[tcp/https\] succeeded\!
</code></pre>
<h2 id=reference>
Reference
<a class=anchor href=#reference>#</a>
</h2>
<p><a href=https://www.domstamand.com/adding-haproxy-as-load-balancer-to-the-kubernetes-cluster/>Adding HAProxy as load balancer to the Kubernetes cluster | Dominique St-Amand (domstamand.com)</a><br>
<a href=https://itnext.io/create-a-highly-available-kubernetes-cluster-using-keepalived-and-haproxy-37769d0a65ba>Create a Highly Available Kubernetes Cluster Using Keepalived and HAproxy | by KubeSphere | ITNEXT</a><br>
<a href=https://kifarunix.com/configure-highly-available-haproxy-with-keepalived-on-ubuntu-20-04/>Configure Highly Available HAProxy with Keepalived on Ubuntu 20.04</a><br>
<a href=http://kifarunix.com>kifarunix.com</a><br>
<a href=https://kifarunix.com/install-and-setup-haproxy-on-ubuntu-20-04/#haproxyconfigurationfile>Install and Setup HAProxy on Ubuntu 20.04 - kifarunix.com</a><br>
<a href=https://www.retinadata.com/blog/keeping-ips-alive-without-keepalived/>Keeping IPs alive without keepalived - retinadata</a><br>
<a href=https://access.redhat.com/documentation/en-us/red_hat_cloudforms/4.6/html/high_availability_guide/index>High Availability Guide Red Hat CloudForms 4.6 | Red Hat Customer Portal</a><br>
<a href=https://docs.d2iq.com/mesosphere/dcos/services/kubernetes/2.4.2-1.15.3/operations/exposing-the-kubernetes-api/>Exposing the Kubernetes API - D2iQ Docs</a></p>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments>
</div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<div class=book-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#introduction>Introduction</a></li>
<li><a href=#prerequisites>Prerequisites</a></li>
<li><a href=#detailed-steps>Detailed steps</a>
<ul>
<li><a href=#install-the-required-packages>Install the required packages</a></li>
<li><a href=#configure-load-balancer>Configure Load Balancer</a></li>
<li><a href=#configure-high-availability-for-haproxy>Configure High availability for HAproxy</a></li>
</ul>
</li>
<li><a href=#completion>Completion</a></li>
<li><a href=#reference>Reference</a></li>
</ul>
</nav>
</div>
</aside>
</main>
</body>
</html>